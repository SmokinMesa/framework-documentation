<template>
    <section :class="componentName">
        <div class="filter-wrapper">
            <h3 class="title">
                <icon-search-ct/>
                {{ resultsReturned }} in stock
            </h3>

            <p>
                Search stock across {{ locations }} locations instantly right here
            </p>

            <!-- TODO not really a link -->
            <a 
                class="clear-filter" 
                href="#" 
                @click.prevent="clearFilters()"
            >
                Clear filters
            </a>

            <a  
                v-if="!isActive"
                class="secondary large outline mobile-filter"
                @click="toggleMobileFilters"
            >
                Filter results <span><icon-arrow-down-ct /></span>
            </a>

            <a  
                v-else    
                class="primary large outline mobile-filter close"
                @click="toggleMobileFilters"
            >
                Close filters <span><icon-arrow-down-ct /></span>
            </a>

            <div class="filters" :class="{ active: isActive }">
                <div class="select">
                    <select
                        id="make"
                        name="make"
                        @change="range='';coin='';getData()"
                        v-model="make"
                    >
                        <option
                            v-for="option in allMakes"
                            :key="option.id"
                            :value="option.id"
                        >
                            {{ option.label }}
                        </option>
                    </select>

                    <label for="make">
                        <icon-arrow-down-ct />
                    </label>
                </div>

                <div
                    class="select"
                    :class="{ disabled: make == '' }"
                >
                    <select
                        id="model"
                        name="model"
                        @change="coin='';getData()"
                        :disabled="make == ''"
                        v-model="range"
                    >
                        <option
                            v-for="option in allRanges"
                            :key="option.id"
                            :value="option.id"
                        >
                            {{ option.label }}
                        </option>
                    </select>

                    <label for="make">
                        <icon-arrow-down-ct />
                    </label>
                </div>

                <div
                    class="select"
                    :class="{ disabled: range == '' }"
                >
                    <select
                        id="coin"
                        name="coin"
                        @change="getData()"
                        :disabled="range == ''"
                        v-model="coin"
                    >
                        <option
                            v-for="option in allTrims"
                            :key="option.id"
                            :value="option.id"
                        >
                            {{ option.label }}
                        </option>
                    </select>

                    <label for="coin">
                        <icon-arrow-down-ct />
                    </label>
                </div>

                <div class="finance">
                    <span>Cash Price</span>

                    <div class="toggle">
                        <input 
                            id="toggle-cb"
                            class="toggle-checkbox" 
                            type="checkbox" 
                        >

                        <label
                            class="label-toggle"
                            @click="togglePayment"
                            for="toggle-cb"
                        >
                            Toggle
                        </label>
                    </div>

                    <span>Monthly Payments</span>
                </div>

                <!-- Cash -->
                <div
                    v-if="finance_type == 'price'"
                    class="select">
                    <select
                        id="min_price"
                        name="min_price"
                        @change="getData()"
                        v-model="minPrice">
                        <option
                            v-for="option in allMinPrice"
                            :key="option.id"
                            :value="option.id"
                        >
                            {{ option.label }}
                        </option>
                    </select>

                    <label for="min_price">
                        <icon-arrow-down-ct />
                    </label>
                </div>

                <div
                    v-if="finance_type == 'price'"
                    class="select"
                >
                    <select
                        id="max_price"
                        name="max_price"
                        @change="getData()"
                        v-model="maxPrice"
                    >
                        <option
                            v-for="option in allMaxPrice"
                            :key="option.id"
                            :value="option.id"
                        >
                            {{ option.label }}
                        </option>
                    </select>

                    <label for="max_price">
                        <icon-arrow-down-ct />
                    </label>
                </div>

                <!-- Monthly -->
                <div
                    v-if="finance_type == 'monthly'"
                    class="select"
                >
                    <select
                        id="monthly_from"
                        name="monthly_from"
                        @change="getData()"
                        v-model="monthlyFrom"
                    >
                        <option
                            v-for="(value, key) in allMonthlyFrom"
                            :key="key"
                            :value="key"
                        >
                            {{ value }}
                        </option>
                    </select>

                    <label for="monthly_from">
                        <icon-arrow-down-ct />
                    </label>
                </div>

                <div
                    v-if="finance_type == 'monthly'"
                    class="select"
                >
                    <select
                        id="monthly_to"
                        name="monthly_to"
                        @change="getData()"
                        v-model="monthlyTo"
                    >
                        <option
                            v-for="(value, key) in allMonthlyTo"
                            :key="key"
                            :value="key"
                        >
                            {{ value }}
                        </option>
                    </select>

                    <label for="monthly_to">
                        <icon-arrow-down-ct />
                    </label>
                </div>

                <div class="separator"/>

                <h4 class="sub-title">
                    Options
                </h4>

                <div class="select">
                    <select
                        id="age"
                        name="age"
                        @change="getData()"
                        v-model="age"
                    >
                        <option value="">Age</option>

                        <option
                            v-for="option in allAge"
                            :key="option.id"
                            :value="option.id"
                        >
                            {{ option.label }}
                        </option>
                    </select>

                    <label for="age">
                        <icon-arrow-down-ct />
                    </label>
                </div>

                <div class="select">
                    <select
                        id="colour"
                        name="colour"
                        @change="getData()"
                        v-model="colour"
                    >
                        <option value="">Colour</option>

                        <option
                            v-for="option in allColour"
                            :key="option.id"
                            :value="option.id"
                        >
                            {{ option.label }}
                        </option>
                    </select>

                    <label for="Colour">
                        <icon-arrow-down-ct />
                    </label>
                </div>

                <div class="select">
                    <select
                        id="transmission"
                        name="transmission"
                        @change="getData()"
                        v-model="transmission"
                    >
                        <option value="">Transmission</option>

                        <option
                            v-for="option in allTransmissions"
                            :key="option.id"
                            :value="option.id"
                        >
                            {{ option.label }}
                        </option>
                    </select>

                    <label for="transmission">
                        <icon-arrow-down-ct />
                    </label>
                </div>

                <div class="select">
                    <select
                        id="fuel_type"
                        name="fuel_type"
                        @change="getData()"
                        v-model="fuel_type"
                    >
                        <option value="">Fuel Type</option>

                        <option
                            v-for="option in allFuelTypes"
                            :key="option.id"
                            :value="option.id"
                        >
                            {{ option.label }}
                        </option>
                    </select>

                    <label for="fuel_type">
                        <icon-arrow-down-ct />
                    </label>
                </div>

                <div class="select">
                    <select
                        id="bodyType"
                        name="bodyType"
                        @change="getData()"
                        v-model="body_type"
                    >
                        <option value="">Body Type</option>

                        <option
                            v-for="option in allBodyType"
                            :key="option.id"
                            :value="option.id"
                        >
                            {{ option.label }}
                        </option>
                    </select>

                    <label for="bodyType">
                        <icon-arrow-down-ct />
                    </label>
                </div>

                <div class="select">
                    <select
                        id="doors"
                        name="doors"
                        @change="getData()"
                        v-model="doors"
                    >
                        <option value="">No. of Doors</option>

                        <option
                            v-for="option in allNoDoors"
                            :key="option.id"
                            :value="option.id"
                        >
                            {{ option.label }}
                        </option>
                    </select>

                    <label for="doors">
                        <icon-arrow-down-ct />
                    </label>
                </div>

                <div class="select">
                    <select
                        id="location"
                        name="location"
                        @change="getData()"
                        v-model="location_name"
                    >
                        <option value="">Location</option>

                        <option
                            v-for="option in allLocations"
                            :key="option.id"
                            :value="option.id"
                        >
                            {{ option.label }}
                        </option>
                    </select>

                    <label for="location">
                        <icon-arrow-down-ct />
                    </label>
                </div>

                <div class="input">
                    <input
                        type="text"
                        id="vrm_partial"
                        name="vrm_partial"
                        placeholder="VRM"
                        @keyup="onVrmUpdate()"
                        v-model="vrm_partial"
                    >

                    <label for="vrm_partial">
                        <icon-search-ct />
                    </label>
                </div>

            </div>
        </div>
    </section>
</template>


<script>
    export default {
        name: 'side-filter-1',
        props: {
            componentName: {
                default: "side-filter-1"
            },

            resultsReturned: {
                default: ''
            },
            params:{
                default: {}
            },
            category:{
                default: 'cars',
            }
        },
        data() {
            return {
                locations: 3,
                toggleMobile: true,
                isActive: false,
                vrmTimeout: null,

                allMakes: [],
                allRanges: [],
                allTrims: {},
                allFuelTypes: {},
                allTransmissions: {},
                allMonthlyFrom: {},
                allMonthlyTo: {},
                allMinPrice: {},
                allMaxPrice: {},
                allAge: {},
                allMileage: {},
                allBodyType: {},
                allNoDoors: {},
                allNoSeats: {},
                allColour: {},
                allInsuranceGroups: {},
                allLocations: {},
                allFilters: false,

                make: '',
                range: '',
                coin: '',
                fuel_type: '',
                finance_type: 'price',
                transmission: '',
                monthlyFrom: '',
                monthlyTo: '',
                minPrice: '',
                maxPrice: '',
                age: '',
                mileage: '',
                body_type: '',
                doors: '',
                noSeats: '',
                colour: '',
                location_name: '',
                vrm_partial: '',
                page: 1,
                sort: 'price|desc',
            }
        },
        created() {
            let $this = this;
            Object.keys($this.params).forEach(function(key) {
               $this[key] = $this.params[key];

            });

            this.$axios.get('/used/' + this.category + '/ajax-search/', {
                params: this.filters
            })
                .then(response => {
                    this.mapDataToArray(response.data);
                }).catch((e) => {
                console.log(e);
                if (e.response.status === 404) {
                    error({statusCode: 404, message: 'Can not load filters'})
                }
            });
        },
        computed: {
            filters() {
                return {
                    make: this.make,
                    range: this.range,
                    coin: this.coin,
                    fuel_type: this.fuel_type,
                    transmission: this.transmission,
                    monthly_from: this.monthlyFrom,
                    monthly_to: this.monthlyTo,
                    min_price: this.minPrice,
                    max_price: this.maxPrice,
                    age: this.age,
                    mileage: this.mileage,
                    body_type: this.body_type,
                    doors: this.doors,
                    seats: this.noSeats,
                    colour: this.colour,
                    location_name: this.location_name,
                    added_since: this.params.added_since,
                    vrm_partial: this.vrm_partial,
                    page: this.params.page,
                    finance_type: this.params.finance_type,
                    sort: this.params.sort,
                };
            }
        },
        methods: {
            togglePayment(section) {
                if (this.finance_type == 'monthly') {
                    this.finance_type = 'price';
                } else {
                    this.finance_type = 'monthly';
                }
            },
            toggleMobileFilters() {
                this.isActive = !this.isActive;

                return false;
            },
            getData() {
                this.$emit('requested-search', this.filters);
                this.$axios.get('/used/cars/ajax-search/', {
                    params: this.filters
                }).then(response => {
                    this.mapDataToArray(response.data);
                }).catch((e) => {
                    console.log(e);
                    if (e.response.status === 404) {
                        error({statusCode: 404, message: 'Can not get all makes'})
                    }
                });
            },
            mapDataToArray(data) {
                this.allMakes = data.options.make;
                this.allRanges = data.options.range;
                this.allTrims = data.options.coin;
                this.allFuelTypes = data.options.fuel_type;
                this.allTransmissions = data.options.transmission;
                this.allMonthlyFrom = data.finance.monthly_from;
                this.allMonthlyTo = data.finance.monthly_to;
                this.allMinPrice = data.options.min_price;
                this.allMaxPrice = data.options.max_price;
                this.allAge = data.options.age;
                this.allMileage = data.options.odometer_value;
                this.allBodyType = data.options.body_type;
                this.allNoDoors = data.options.doors;
                this.allNoSeats = data.options.seats;
                this.allColour = data.options.colour;
                this.allLocations = data.options.location_name;
            },
            clearFilters(){
                this.make= '';
                this.range= '';
                this.coin= '';
                this.fuel_type= '';
                this.finance_type= 'price';
                this.transmission= '';
                this.monthly_from= '';
                this.monthly_to= '';
                this.min_price= '';
                this.max_price= '';
                this.monthlyFrom= '';
                this.monthlyTo= '';
                this.minPrice= '';
                this.maxPrice= '';
                this.age= '';
                this.mileage= '';
                this.body_type= '';
                this.doors= '';
                this.noSeats= '';
                this.colour= '';
                this.location_name= '';
                this.vrm_partial = '';
                this.page = 1;
                this.sort="price|desc";
                this.getData();
            },
            onVrmUpdate() {
                clearTimeout(this.vrmTimeout);
                console.log('clear time');

                this.vrmTimeout = setTimeout(() => {
                    console.log('time up');
                    this.getData();
                }, 1000);
            }
        },
    }
</script>